#!/bin/bash

setup_dbus() {
    dbuslaunch="`which dbus-launch 2>/dev/null`"
    if [ -n "$dbuslaunch" ] && [ -x "$dbuslaunch" ] && [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
      eval $($dbuslaunch --sh-syntax --exit-with-session)
    fi
}

setup_gnome_keyring() {
    keyringdaemon="`which gnome-keyring-daemon 2>/dev/null`"
    eval $($keyringdaemon --start --components=pkcs11,secrets,ssh)
    export SSH_AUTH_SOCK
}

#export QT_PLUGIN_PATH=$T_PLGIN_PATH:/usr/lib/kde4/plugins/
export GTK_IM_MODULE="xim"
. ~/.profile


if [ $(hostname) = artstation ]
then
    . ~/.local/bin/mywacomsetup.sh
    jack_control dps device hw:CARD=Audigy &
    jack_control dps period 512 &
fi


# update pulseaudio settings
~/.local/bin/update-pulseaudio.sh


# load nvidia settings
if which nvidia-settings > /dev/null 2>&1 && [ -f ~/.nvidia-settings-rc ]
then
    nvidia-settings --load-config-only
fi


# setup keyboard layout
setxkbmap -layout us,ru
setxkbmap -option
setxkbmap -option "grp:caps_toggle,grp_led:scroll,lv3:ralt_switch,compose:rctrl,esperanto:qwerty,terminate:ctrl_alt_bksp"
[ $(hostname) = blackbox ] && setxkbmap -option "grp_led:caps"


# session specific gtk.css
cat > ~/.config/gtk-3.0/session.css <<EOF
/* generated by ~/.xsesssionrc */
EOF
if [ _$XDG_SESSION_DESKTOP = _i3 ] || \
    [ _$XDG_SESSION_DESKTOP = _awesome ]
then
cat >> ~/.config/gtk-3.0/session.css <<EOF

/* remove CSD */
.window-frame, .window-frame:backdrop {
 box-shadow: 0 0 0 black;
 border-style: none;
 margin: 0;
 border-radius: 0;
}

.titlebar {
 border-radius: 0;
}

.window-frame.csd.popup {
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.13);
}

EOF
fi


if [ _$XDG_SESSION_DESKTOP = _i3 ] || \
    [ _$XDG_SESSION_DESKTOP = _awesome ] || \
    [ _$XDG_SESSION_DESKTOP = _xfce ] || \
    [ _$XDG_SESSION_DESKTOP = _mate ]
then
    # env
    export DESKTOP_SESSION=gnome  # sets qt4 app appearence
    if which qt5ct
    then
        export QT_QPA_PLATFORMTHEME=qt5ct  # sets qt5 app appearence
    else
        export QT_STYLE_OVERRIDE=gtk  # sets qt5 app appearence
    fi
fi


if [ _$XDG_SESSION_DESKTOP = _i3 ] || \
    [ _$XDG_SESSION_DESKTOP = _awesome ]
then
    # env
    setup_dbus
    setup_gnome_keyring

    # notification daemon
    dunst &

    # xfce4 integration
    export XDG_CURRENT_DESKTOP=XFCE
    dex --autostart -e XFCE

    # stuff
    compton &
    kbdd &

    # in some cases screen layout not yet ready
    (
    for n in `seq 10`
    do
        sleep $n
        setwallpaper.sh
    done
    ) &
fi


# workaround for https://github.com/awesomeWM/awesome/issues/196
# should be fixed in awesome-3.6.*
if [ _$XDG_SESSION_DESKTOP = _awesome ] && \
    [ $(awesome --version | sed -n 's/awesome v\([0-9]*\.[0-9]*\).*/\1/p') = 3.5 ]
then
    xkbcomp $DISPLAY - | egrep -v "group . = AltGr;" | xkbcomp - $DISPLAY
fi


unset setup_dbus
unset setup_gnome_keyring
