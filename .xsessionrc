#!/bin/bash

setup_dbus() {
    dbuslaunch="`which dbus-launch 2>/dev/null`"
    if [ -n "$dbuslaunch" ] && [ -x "$dbuslaunch" ] && [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
      eval $($dbuslaunch --sh-syntax --exit-with-session)
    fi
}

setup_gnome_keyring() {
    keyringdaemon="`which gnome-keyring-daemon 2>/dev/null`"
    eval $($keyringdaemon --start --components=pkcs11,secrets,ssh)
    export SSH_AUTH_SOCK
}

#export QT_PLUGIN_PATH=$T_PLGIN_PATH:/usr/lib/kde4/plugins/
export GTK_IM_MODULE="xim"
. ~/.profile
/home/ildar/.local/bin/mykeyboardsetup.sh


# session specific gtk.css
cat > ~/.config/gtk-3.0/session.css <<EOF
/* generated by ~/.xsesssionrc */
EOF
if [ _$XDG_CURRENT_DESKTOP = _i3 ] || [ _$XDG_SESSION_DESKTOP = _awesome ]
then
cat >> ~/.config/gtk-3.0/session.css <<EOF

/* remove CSD */
.window-frame, .window-frame:backdrop {
 box-shadow: 0 0 0 black;
 border-style: none;
 margin: 0;
 border-radius: 0;
}

.titlebar {
 border-radius: 0;
}

.window-frame.csd.popup {
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.13);
}

EOF
fi


if [ _$XDG_CURRENT_DESKTOP = _i3 ] || [ _$XDG_SESSION_DESKTOP = _awesome ]
then
    # env
    setup_dbus
    setup_gnome_keyring
    export QT_STYLE_OVERRIDE=gtk

    # xfce4 integration
    export XDG_CURRENT_DESKTOP=XFCE
    dex --autostart -e XFCE

    # stuff
    compton &
    kbdd &

    # in some cases screen layout not yet ready
    (
    for n in `seq 10`
    do
        sleep $n
        setwallpaper.sh
    done
    ) &


elif [ _$XDG_CURRENT_DESKTOP = _XFCE ]
then
    # env
    export QT_STYLE_OVERRIDE=gtk

elif [ _$XDG_CURRENT_DESKTOP = _MATE ]
then
    # env
    export QT_STYLE_OVERRIDE=gtk

fi
 
 
if [ $(hostname) = artstation ]
then
    . ~/.local/bin/mywacomsetup.sh
    jack_control dps device hw:CARD=Audigy &
    jack_control dps period 512 &
fi


# update pulseaudio settings
which update-pulseaudio.sh 2> /dev/null && update-pulseaudio.sh

# load nvidia settings
if which nvidia-settings > /dev/null 2>&1 && [ -f ~/.nvidia-settings-rc ]
then
    nvidia-settings --load-config-only
fi


if [ -x /usr/sbin/bbackupctl ] && [ -e ~/.config/boxbackup/bbackupd.conf ]
then
    [ -e ~/.cache/bbackupd/bbackupd.pid ] && kill -0 $(cat ~/.cache/bbackupd/bbackupd.pid) \
        || /usr/sbin/bbackupd -c ~/.config/boxbackup/bbackupd.conf
fi


unset setup_dbus
unset setup_gnome_keyring
